\documentclass[../thesis.tex]{subfiles}

\ifSubfilesClassLoaded{
  \externaldocument{../build/2-preliminaries}%
  \externaldocument{../build/3-logics}%
}

\begin{document}
\chapter{Type Theories}

\section{Fibrations as algebraic structure}
A fundamental tool in the different semantics of type theories is the notion of fibration. For example,
they allow for modeling substitution in types and terms in a principled manner, and provide thus provide
an alternative to presheaves. Furthermore, since they make no mention of $\Cat$ directly, we can attempt
to describe a theory of fibrations in terms of an $\cF$-limit sketch, and this is what provides the basis
for using $\cF$-logics and sketches to describe categorical semantics of type theories.

\begin{definition}[Cartesian morphism]
  Let $p : A \to B$ be a tight morphism of an $\cF$-category $\bA$. A 2-cell $\phi : a_1 \to a_2 : X \loose A$ is
  called \emph{$p$-cartesian} if for every $g : Y \loose X$, $a_0 : Y \loose A$, $\alpha : a_0 \to a_2g$, and
  $\beta : pa_0 \to pa_1g$ with $\beta \circ p\phi = p\alpha$, there exists a unique $\gamma : a_0 \to a_1g$ such
  that $\beta = p\gamma$ and $\alpha = \phi g \circ \gamma$. We will call the data $(g,a_0,\alpha,\beta)$
  satisfying the equality $\beta \circ p\phi = p\alpha$ a cartesian cone.

  If $A^\to$ exists in $\bA$, we say that a 1-cell $f : X \to A^\to$ is cartesian when $\lambda f : \dom f \to
  \cod f$, the 2-cell induced by $f$, is cartesian.
\end{definition}
\begin{proposition}
  Let $p : A \to B$ be a tight morphism in an $\cF$-category $\bA$ with finite weighted limits and $\phi : a_1 \to a_2 : X
  \loose A$ a 2-cell. Consider the diagram $D : \bJ \to \cA$ (with $\bJ$ the obvious shape $\cF$-category) given by
  \[\begin{codi}
    \obj { X & A & B \\};
    \mor X ["a_1",name=x]:[->,bend left] A p:-> B;
    \mor X ["a_2",name=y,swap]:[->,bend right] A;
    \mor x \phi:-2> y;
  \end{codi}\]
  and weight $W : \bJ \to \bF$ generated by
  \[\begin{codi}
    \obj { |(X)| 1 & |(A)| H & |(B)| 3 \\};
    \mor X ["1",name=x]:[->,bend left] A c:-> B;
    \mor X ["2",name=y,swap]:[->,bend right] A;
    \mor x \phi:-2> y;
  \end{codi}\]
  where $H = \set{0 \to 2 \from 1}$ is the generic (tight) cospan, and $c : H \to 3$ maps the morphism $1 \to 2$ to
  the corresponding morphism in $3$ and $0 \to 2$ to the composite $0 \to 1 \to 2$ in $3$.

  A $W$-weighted cone over $D$ is exactly a cartesian cone over $\phi$.
\end{proposition}

\begin{proposition}\label{prop:cartesian by limit}
  Let $\bA$ be an $\cF$-category with finite weighted limits, $p : A \to B$ a 1-cell in $\bA$, and $\phi : a_1 \to
  a_2 : X \loose A$ a 2-cell in $\bA$. Then $\phi$ is cartesian if and only if $\ell = (\cod, \dom, \phi\cod \circ
  \lambda, p\lambda)$ is a universal cartesian cone with apex $A \comma a_1$.
\end{proposition}
\begin{proof}
  In the left-to-right direction, suppose $\phi$ is cartesian. We must show that for every object $Y$, the following
  hold:
  \begin{enumerate}[label=(\arabic*)]
    \item for every cartesian cone $(g,a,\alpha,\beta)$ with apex $Y$, there exists a unique morphism $h : Y \to A
      \comma a$ such that $g = \cod h$, $a = \dom h$, $\alpha = (\phi\cod \circ \lambda)h$ and $\beta = p\lambda h$.
    \item for every morphism of cones $m : (g,a,\alpha,\beta) \to (g',a',\alpha',\beta')$ there exists a unique
      morphism $h_m : h \to h'$ such that $m = h_m^* \ell$.
  \end{enumerate}
  For (1), note that since $(g,a,\alpha,\beta)$ is a cartesian cone and $\phi$ is cartesian, there exists a unique
  2-cell $\gamma : a \to a_1g$ such that $\alpha = \phi \circ \gamma$ and $\beta = p\gamma$. By the universal
  property of $A \comma a_1$, there then exists a unique morphism $\bar\gamma : Y \to A \comma a_1$ with $\lambda\bar
  \gamma = \gamma$. In particular, we have that $\cod\bar\gamma = g$, $\dom\bar\gamma = a$, $\alpha = \phi \circ
  \lambda\bar\gamma$, and $\beta = p\lambda\bar\gamma$, so taking $h = \bar\gamma$ we are done. Furthermore, $h =
  \bar\gamma$ is the unique such map by uniqueness of $\bar\gamma$ and $\gamma$.

  For (2), suppose we are given a modification $m : (g,a,\alpha,\beta) \to (g',a',\alpha',\beta')$. Concretely, $m$
  consists of two morphisms $m_1 : g \to g'$ and $m_2 : a \to a'$ such that the following squares commute:
  \[\begin{codi}[tetragonal=base 6em height 4.5em]
    \obj { a & a' & & pa & pa' \\ a_2g & a_2g' & & pa_1g & pa_1g' \\};
    \mor[swap] a \alpha:-> a_2g a_2m_1:-> a_2g';
    \mor a m_2:-> a' \alpha':-> a_2g';

    \mor pa pm_2:-> pa' \beta':-> pa_1g';
    \mor[swap] pa \beta:-> pa_1g pa_1m_1:-> pa_1g';
  \end{codi}\]
  We want to show that the square
  \[\begin{codi}[tetragonal=base 6em height 4.5em]
    \obj {a & a' \\ a_1g & a_1g' \\};
    \mor a m_2:-> a' \gamma':-> a_1g';
    \mor[swap] a \gamma:-> a_1g a_1m_1:-> a_1g';
  \end{codi}\]
  commutes as well, as that induces the desired unique morphism $\bar m : \bar \gamma \to \bar \gamma'$ with the
  desired properties. To that end, consider the cartesian cone over $Y$ given by $(g', a, \alpha'' = \alpha' \circ
  m_2, \beta'' = \beta'  \circ pm_2)$. To see that this is indeed a cone, we must show that $p\alpha'' = p\phi \circ
  \beta''$, but this follows from simple computation:
  \[p\alpha'' = p(\alpha' \circ m_2) = p\alpha' \circ pm_2 = p\phi \circ \beta' \circ pm_2 = p\phi \circ \beta''\]
  Since $(g',a,\alpha'',\beta'')$ is a cartesian cone and $r$ is cartesian, there exists a unique lift $\gamma''$
  with $p\gamma'' = \beta''$ and $\alpha'' = \phi g' \circ \gamma''$. But we have already that
  \[p(\gamma' \circ m_2) = p\gamma' \circ pm_2 = \beta' \circ pm_2 = \beta'' \text{\quad and \quad}
  \phi g' \circ \gamma' \circ m_2 = \alpha' \circ m_2 = \alpha'',\]
  and similarly
  \[p(a_1m_1 \circ \gamma) = pa_1m_1 \circ p\gamma = pa_1m_1 \circ \beta = \beta''\]
  and
  \[\phi g' \circ a_1m_1 \circ \gamma = a_2m_1 \circ \phi g \circ \gamma = a_2 m_1 \circ \alpha = \alpha'',\]
  where we use the interhcange law to commute $\phi$ and $m_1$.
  In particular, we see that both $\gamma' \circ m_2$ and $a_1m_1 \circ \gamma$ provide universal morphisms for
  the cartesian cone $(g',a,\alpha'', \beta'')$, from which we conclude that they must be identical by the uniqueness
  of such morphisms. Hence the diagram
  \[\begin{codi}[tetragonal=base 6em height 4.5em]
    \obj {a & a' \\ a_1g & a_1g' \\};
    \mor a m_2:-> a' \gamma':-> a_1g';
    \mor[swap] a \gamma:-> a_1g a_1m_1:-> a_1g';
  \end{codi}\]
  commutes.

  For the right-to-left direction, suppose that $(\cod,\dom,\phi\cod \circ \lambda, p\lambda)$ is a limiting cone
  with apex $A \comma a_1$, and let $(g,a,\alpha,\beta)$ be any cartesian cone with apex $Y$. By the universal
  property of limiting cones, there exists a unique morphism $\bar\gamma : Y \to A \comma a_1$ such that
  $\cod\bar\gamma = g$, $\dom\bar\gamma = a$, $(\phi\cod \circ \lambda)\bar\gamma = \alpha$, and
  $p\phi\bar\gamma = \beta$. In particular, taking $\gamma = \lambda\bar\gamma : a \to a_1g$, we have the
  desired morphism, and it is unique by the universal property of $A \comma a_1$.
\end{proof}


\begin{definition}[Fibration in an $\cF$-category]
  A \emph{fibration} in an $\cF$-category $\bA$ is a tight morphism $p : A \to B$ such that for every morphism $\phi :
  a_1 \to p a_2 : X \to B$ (with $a_1 : X \to B$ and $a_2 : X \to A$) there exists a $p$-cartesian morhism $\bar \phi :
  a_1' \to p a_2$ such that $\phi = p\bar\phi$.
\end{definition}

\begin{proposition}
  Let $p : A \to B$ be a tight morphism in an $\cF$-category $\bA$ with finite weighted limits. Then the
  following are equivalent:
  \begin{enumerate}[label=(\arabic*)]
    \item $p$ is a fibration.
    \item There exists a map $\ell : B \comma p \to A$ with $p\ell = \dom$ and $p$-cartesian 2-cell $\epsilon :
      \ell \to \cod$ with $p\epsilon = \lambda$, where $\lambda : \dom \to p\cod$ is the universal 2-cell for $B
      \comma p$.
    \item The map $t : A^\to \to B \comma p$ has a section $r : B \comma p \to A^\to$ which is $p$-cartesian.
    \item The canonical map $t : A^\to \to B \comma p$ has a right adjoint $r : B \comma p \to A^\to$
      with identity counit.
    \item The map $i : A \to B \comma p$ induced by the identity $1_p$ has a right adjoint $\ell : B \comma p
      \to A$ in the slice $\bA/B$ with invertible unit.
  \end{enumerate}
\end{proposition}
\begin{proof}
  We show that $(1) \iff (2) \implies (3) \implies (4) \implies (2)$ and $(2) \iff (5)$.

  For $(1) \implies (2)$, note that since $p$ is a fibration, there exists a $p$-cartesian lift $\epsilon : \ell
  \to \cod : B \comma p \to A$ for the 2-cell $\lambda : \dom \to p\cod : B \comma p \to B$, and this lift
  satisfies $p\epsilon = \lambda$. This is exactly the map we require.

  For $(2) \implies (1)$, note that since $\epsilon : \ell \to \cod$ is $p$-cartesian, so is $\epsilon x$ for
  all $f : X \loose B \comma p$. In particular, for any 2-cell $\phi : b \to pa$ with $b : X \to B$ and $a : X
  \to A$, we have an induced 1-cell $f : X \loose B \comma p$ with $\lambda f = \phi$. Then $\epsilon f$ is $p$-%
  cartesian, and by the properties of $\epsilon$, we have that $p\epsilon f = \lambda f = \phi$, so $\epsilon f$
  is a cartesian lift for $\phi$. Since $\phi$ was an arbitrary such 2-cell, we conclude that every such 2-cell
  has a caresian lift, which is exactly what it means for $p$ to be a fibration.


  For $(2) \implies (3)$, note that $\epsilon$ induces a map $r : B \comma p \to A^\to$ with $\lambda'r =
  \epsilon$, where $\lambda' : \dom' \to \cod' : A^\to \to A$ is the universal 2-cell associated with $A^\to$.
  This map then satisfies that $\lambda tr = p\lambda' r = p\epsilon = \lambda$, so that $tr = 1_{B \comma p}$,
  and $r$ is $p$-cartesian by definition.

  suppose that $p$ is a fibration. We require first of all a map $r : B \comma p \to
  A^\to$, which we then show is a $p$-cartesian section to $t : A^\to \to B \comma p$. Such a map $r$ is
  equivalently a 2-cell $\lambda r : \dom r \to \cod r : B \comma p \to A$. Since $p$ is a fibration, there
  exists a $p$-cartesian lift $\bar r : x \to \cod' : B \comma p \to A$ for the map $\lambda' : \dom' \to p
  \cod' : B \comma p \to B$, where $x : B \comma p \to A$ is such that $px = \dom'$. This map $\bar r$ induces
  a 1-cell $r : B \comma p \to A^\to$ with $\lambda \bar r = r$. In particular, we see that $\lambda' t r =
  p\lambda r = p\bar r = \lambda'$, so that $tr = 1_{B \comma p}$, as desired. Hence $r : B \comma p \to A^\to$
  is a $p$-cartesian section of $t$.

  For $(3) \implies (4)$, suppose $r$ is a $p$-cartesian 1-cell with $tr = 1_{B \comma p}$. We show that $r$
  is also a right-adjoint to $t$, for which we must find a unit $\eta : 1_{A^\to} \to rt$. By the universal
  property of $A^\to$, $\eta$ is equivalent to a commuting square
  \[\begin{codi}[tetragonal=base 6em height 4.5em]
    \obj {\dom' & \dom'rt \\ \cod' & \cod'rt \\};
    \mor       (dom ') \eta_1:-> (dom 'rt) \lambda'rt:-> (cod 'rt);
    \mor[swap] (dom ') \lambda':-> (cod ') \eta_2:-> (cod 'rt);
  \end{codi}\]
  Since $\cod'rt = \cod trt = \cod t = \cod'$, it would suffices to find a map $\eta_1$ such that
  $\lambda' = \lambda'rt \circ \eta_1$, since $\eta_2 = 1_{\cod'}$ then makes the above square commute. Since
  $r$ is a $p$-cartesian 1-cell, $\lambda'rt$ is a $p$-cartesian 2-cell, whereby there exists a unique universal
  map $\gamma : \dom' \to \dom'rt$ induced by the cone $(\cod', \dom', \lambda', 1_{p\dom'})$ with $p\gamma =
  1_{p\dom'}$ and $\lambda' = \lambda'rt \circ \gamma$, so we may take $\eta_1 = \gamma$, and then $\eta$ is
  the universal map induced by the square
  \[\begin{codi}[tetragonal=base 6em height 4.5em]
    \obj {\dom' & \dom'rt \\ \cod' & \cod'rt \\};
    \mor       (dom ') \gamma:-> (dom 'rt) \lambda'rt:-> (cod 'rt);
    \mor[swap] (dom ') \lambda':-> (cod ') 1_{\cod'}:-> (cod 'rt);
  \end{codi}\]
  To verify that $\eta : 1_{A^\to} \to rt$ is indeed the unit of an adjunction $t \dashv r$, we must verify that
  $t\eta = 1_t$ and $\eta r = 1_r$. For the former, it suffices to show that $\dom t\eta = 1_{\dom t}$ and
  $\cod t\eta = 1_{\cod t}$. But these hold since
  \[\dom t\eta = p\dom'\eta = p\gamma = 1_{p\dom'} = 1_{\dom t} \qquad\text{ and }\qquad
  \cod t\eta = \cod'\eta = 1_{\cod'} = 1_{\cod t}.\]
  Hence $t\eta = 1_t$. For the latter equation $\eta r = 1_r$, we must show that $\gamma r = 1_{\dom' r}$,
  for which it suffices to see that $1_{\dom' r}$ and $\gamma r$ both are universal morphisms for the same
  $p$-cartesian cone over $\lambda'r : \dom' r \to \cod' r : B\comma p \to A$. The cone we consider is
  specifically $(1_{B \comma p}, \dom'r, \lambda'r, 1_{p\dom'r})$ with apex $B \comma p$, which clearly
  satisfies $p\lambda'r = p\lambda'r \circ 1_{p\dom'}$. Furthermore, we clearly see that $1_{\dom' r}$ is
  a universal map over the cone, and that $p\gamma r = 1_{p\dom' r}$ and $\lambda'r \circ \gamma r =
  \lambda'rtr \circ \gamma r = (\lambda'rt \circ \gamma)r = \lambda'r$, so $\gamma r$ is another such
  universal map. Hence $\gamma r = 1_{\dom' r}$, from which we conclude that $\eta r = 1_r$. Hence
  $\eta$ is the unit of an adjunction $t \dashv r$ with identity counit.

  For $(4) \implies (2)$, we must show that the right adjoint $r : B \comma p \to A^\to$ is $p$-cartesian, so let
  $(g,a,\alpha,\beta)$ be a $p$-cartesian cone over $\lambda' r : \dom' r \to \cod' r$ with apex $Y$. Thus
  $g : Y \to B \comma p$, $a : Y \to A$, $\alpha : a \to \cod'r g$, and $\beta : pa \to p\dom'rg = \dom trg
  = \dom g$.
\end{proof}

\begin{notation}
  For any fibration $p : A \to B$ with a chosen lifting $\epsilon : \ell \to \cod$ with $\ell : B \comma p \to A$
  as in (2), and any object $X$ and morphisms $a : X \to A$, $b : X \to B$, and $\sigma : b \to pa$, we write
  $A[\sigma] \coloneq \ell\bar\sigma$, where $\bar \sigma : X \to B \comma p$ is the map induced by $\sigma$.
\end{notation}

\section{From syntax to \texorpdfstring{$\cF$}{F}-logics}
In this section we show a correspondence between the syntax of a deductive theory, presented by judgements and
inference rules, and finite limit $\cF$-logics. The connection is generally as follows: a (dependent) judgement
$d\;\cD \vdash j\;\cJ$ is interpreted is a tight morphism $j : \cJ \to \cD$, with the idea that the fibers of
$j$ over any instance $d\;\cD$ corresponds to $d\;\cD \vdash j\;\cJ$. A non-dependent judgement can then be
viewed as a judgement over the terminal object $1$, so that the dependency is trival. Equivalently a non-dependent
judgement is just an object. The 2-categorical structure gives us, for each judgement $\cJ$, a judgement of
morphisms $\cJ^\to$. In modelling type theory, we would for example have a judgement of contexts $\vdash \ctx$,
and then a judgement of substitions $\Gamma\ctx, \Delta\ctx \vdash \sigma \ctx^\to$. Given a (dependent) judgement
of types over contexts $\rty : \ty \to \ctx$, we would then want to formulate a rule for stability under such
substitutions:
\begin{mathpar}
  \infer{\Gamma\ctx,\Delta\ctx \vdash {{\sigma \ctx^\to}} \\ \Delta \ctx \vdash A\ty}{\Gamma \ctx \vdash
  \sub(A,\sigma) \ty}
\end{mathpar}
We capture this rule as a loose morphism $\sub : \ctx^\to \pb[\cod]{\rty} \ty \to \ty$ for which the following
triangle commutes.
\[\begin{codi}[tetragonal=base 4.5em height 4.5em]
  \obj {|(P)| \ctx^\to \pb[\cod]{\rty} \ty & & \ty \\ & \ctx \\};
  \mor ctx \dom\pi_1:<- P \sub:-> ty \rty:-> ctx; 
\end{codi}\]
If we now note that $\ctx^\to \pb[\cod]{\rty} \ty \cong \ctx \comma \rty$, we see that $\sub$ is exactly as the
morphism $\ell : \ctx \comma \rty \to \rty$ specifying the domain of the lifting in a fibration $\ty \to \ctx$.


\begin{proposition}
  Let $A$ be any object of an $\cF$-category $\bA$ with finite weighted $\cF$-limits. Then any 2-cell $\rho : a
  \to b : X \to A^\to$ is $\cod$-cartesian if and only if the following square is a pullback in $\bA(X,A)$
  \[\begin{codi}[tetragonal=base 5.5em height 4.5em]
    \obj {\dom a & \dom b \\ \cod a & \cod b \\};
    \mor (dom a) \dom\rho:-> (dom b) \lambda b:-> (cod b);
    \mor[swap] (dom a) \lambda a:-> (cod a) \cod\rho:-> (cod b);
  \end{codi}\]
\end{proposition}

\begin{proposition}
  Let $f : A \to B^\to$ be a morphism in an $\cF$-category $\bA$ with finite weighted $\cF$-limits. Then for any
  2-cell $\rho : a \to b : X \to A$, the whiskering $f\rho$ corresponds to the commuting square
  \[\begin{codi}[tetragonal=base 6.5em height 4.5em]
    \obj {\dom fa & \dom fb \\ \cod fa & \cod fb \\};
    \mor (dom fa) \dom f\rho:-> (dom fb) \lambda fb:-> (cod fb);
    \mor[swap] (dom fa) \lambda fa:-> (cod fa) \cod f\rho:-> (cod fb);
  \end{codi}\]
\end{proposition}

\begin{lemma}
  For any fibration $p : A \to B$ and 2-cells $a \xrightarrow{n} b \xrightarrow{m} c : X \to A$, if $m\circ n$
  and $m$ are $p$-cartesian, then so is $n$.
\end{lemma}
\begin{proof}
  Suppose we are given a $p$-cartesian cone over $n$:
  \[\begin{codi}[tetragonal=base 5.5em height 3.5em]
    \obj { |(Y)| Y & |(X)| X & |(A)| A \\ & & |(B)| B \\};
    \mor X ["b",name=x]:[->,bend left] A ["p",name=p]:-> B;
    \mor X ["a",name=y,swap]:[->,bend right] A;
    \mor y n:[-2>] x;
    \mor Y ["x",name=a]:[->, bend left=5em] A;
    \mor Y ["g",name=g]:-> X;
    \mor Y ["pc",name=pa,swap]:[->, bend right=2em] B;
    \mor[swap] a {{k}}:[-2>,slide=0.1em] X;
    \mor[swap] pa {{l}}:[-2>,slide=0.4em, shorten=0.4em] X;
  \end{codi}\]
  Then we have that
  \[p(mg \circ k) = pmg \circ pk = pmg \circ png \circ l = p(m \circ n)g \circ l,\]
  so since $m \circ n$ is $p$-cartesian, there exists a unique map $\gamma : x \to a$ such that $p\gamma = l$
  and $(m \circ n)g \circ \gamma = mg \circ k$. We still need to show that $ng \circ \gamma = k$, but this
  follows from $m$ being $p$-cartesian, since $k$ is the unique map $\gamma'$ such that $mg \circ \gamma' = mg
  \circ k$ and $p\gamma' = pk$. Since $mg \circ ng \circ \gamma = mg \circ k$ and $p(ng \circ \gamma) =
  png \circ p\gamma = png \circ l = pk$, we see that $ng \circ \gamma$ also satisfies the properties of
  $\gamma'$, and so we conclude that by uniqueness that $ng \circ \gamma = k$.
\end{proof}

\section{Comprehension Categories and Categories with Attributes}
We begin by constructing an finite limit logic for comprehension categories. Recall that a comprehension category
consist of commutative triangle in $\Cat$
\[\begin{codi}[hexagonal=horizontal side 6em angle 45] 
  \obj{\cU &   \cC^\to \\
           & \cC \\};
  \mor  cU \chi:-> (cC ^to) \cod:-> cC;
  \mor[swap] cU u:-> cC;
\end{codi}\]
where $u: \cU \to \cC$ is a fibration, and $\chi$ preserves cartesian morphisms.

To axiomatise this as a finite $\cF$-limit logic, we consider the sketch whose underlying $\cF$-category is generated
by a diagram as above, with $\chi$ loose and $u$ and $\cod$ tight. Further, we want $u$ to be a fibration, so we add
as a generator the maps $t : \cU^\to \to \cC \comma u$ and a section $r : \cC \comma u \to \cU^\to$, such that $r$
will be cartesian. Since $\chi$ is supposed to preserve cartesian morphisms, we will ask that $\chi^\to r$ is cartesian
as well, as that says that the image of cartesian lifts are cartesian, which suffices. We shall call the logic generated
by this sketch $\Comp$. Another very relevant logic is that of categories with attributes, where $u$ is supposed to be
discrete. For this, we let $r$ be a full inverse, rather than just a section, to $t$, but still only require $\chi^\to r$
to be cartesian.

Note that all of this data is immediately describable as a finite limit logic;
from example \cref{ex:fib}, we see that we can ask $\cU$ to be a fibration, and similarly that $\cC^\to$ is the arrow
object of $\cC$. More formally, we let $\Comp$ be the $\cF$-theory generated by the finite limit $\cF$-sketch $(\bC,
\cS)$ with objects, morphisms and 2-cells in the diagrams \todo{Mark out which morphisms are supposed to be loose,
which I'm currently not sure about.}
\begin{mathpar}
  \hspace*{-2.5em}\begin{codi}[hexagonal=horizontal side 7em angle 50] 
    \obj{\cU & \cC^\to \\ & \cC \\};
    \mor  cU \chi:≈> (cC ^to) \cod_\cC:-> cC;
    \mor[swap] cU u:-> cC;
  \end{codi}
  \and
  \begin{codi}
    \obj{\cC^\to \\ \cC\\ };
    \mor[swap]:[bend right=36mu] (cC ^to) \dom_\cC:-> cC;
    \mor :[bend left=36mu] * \cod_\cC:-> *;
    \mor (dom _cC) \lambda_\cC:-2> (cod _cC);
  \end{codi}
  \and
  \begin{codi} 
    \obj{\cC \comma u & \cU \\ |(cC1)| \cC & |(cC2)| \cC \\};
    \mor (cC comma u) \cod_\cC^u:-> cU u:-> cC2;
    \mor[swap] * \dom_\cC^u:-> cC1 1_\cC:-> *;
    \mor cC1 \lambda_\cC^u:-2> cU;
  \end{codi}
  \and
  \begin{codi}[tetragonal=base 6em height 5em] 
    \obj{|(A)| \cC \comma u \\ |(B)| \cU \\};
    \mor[swap]:[bend right] A r:rightsquigarrow B;
    \mor:[bend left] A ["\cod^u_\cC",name=cod]:≈> B;
    \mor[] r \ell:[-2>, shorten=0.4em] cod;
  \end{codi}
  \and
  \begin{codi}[tetragonal=base 7em height 4.5em]
    \obj{|(A)| \cU \comma r & |(B)| \cC \comma u \\ |(C)| \cU & |(D)| \cU \\};
    \mor A \cod_\cU^r:-> B r:-> D;
    \mor[swap] * \dom_\cU^r:-> C 1_\cU:-> *;
    \mor C \lambda_\cU^r:-2> B;
  \end{codi}
  \and
  \begin{codi}[tetragonal=base 7em height 4.5em]
    \obj{|(A)| \cC^\to \comma \chi r & |(B)| \cC \comma u \\ |(C)| \cC^\to & |(D)| \cC^\to \\};
    \mor A {{\cod_{\cC^\to}^{\chi r}}}:-> B \chi r:-> D;
    \mor[swap] * {{\dom_{\cC^\to}^{\chi r}}}:-> C 1_\cU:-> *;
    \mor C {{\lambda_{\cC^\to}^{\chi r}}}:-2> B;
  \end{codi}
  \and
  \begin{codi}[tetragonal=base 8em height 4.5em]
    \obj { |(Y)| \cU \comma r & |(X)| \cC \comma u & |(A)| \cU \\ & & |(B)| \cC \\};
    \mor X [mid, "\cod^u_\cC",name=x]:[->,bend left] A ["u",name=p]:-> B;
    \mor X [mid,"r",name=y,swap]:[->,bend right] A;
    \mor y \ell:[-2>,shorten=-0.2em, slide=0.3em] x;
    \mor Y ["\dom^r_\cU",name=a]:[->, bend left=5em] A;
    \mor Y ["\cod^r_\cU",name=g]:-> X;
    \mor Y ["u\dom^r_\cU",name=pa,swap]:[->, bend right=2em] B;
    \mor[swap] a {{\ell\cod^r_\cU \circ \lambda^r_\cU}}:[-2>,slide=0.1em] X;
    \mor[swap] pa {{u\lambda^r_\cU}}:[-2>,slide=0.4em, shorten=0.4em] X;
  \end{codi}
  \and
  \begin{codi}[tetragonal=base 8em height 4.5em]
    \obj { |(Y)| \cC^\to \comma \chi r & |(X)| \cC \comma u & |(A)| {\cC^\to} \\ & & |(B)| \cC \\};
    \mor X [mid, "{\chi\cod^r_\cU}",name=x]:[->,bend left] A ["\cod_\cC",name=p]:-> B;
    \mor X [mid,"\chi r",name=y,swap]:[->,bend right] A;
    \mor y \chi\ell:[-2>,shorten=-0.2em, slide=0.3em] x;
    \mor Y ["{\dom^{\chi r}_{\cC^\to}}",name=a]:[->, bend left=5em] A;
    \mor Y ["{\cod^{\chi r}_{\cC^\to}}",name=g]:-> X;
    \mor Y ["{\cod_\cC\dom^{\chi r}_{\cC^\to}}",name=pa,swap]:[->, bend right=2em] B;
    \mor[swap] a {{\chi\ell\cod^{\chi r}_{\cC^\to} \circ \lambda^{\chi r}_{\cC^\to}}}:[-2>,slide=0.1em] X;
    \mor[swap] pa {{\cod_\cC \lambda^{\chi r}_{\cC^\to}}}:[-2>,slide=0.4em, shorten=0.4em] X;
  \end{codi}
\end{mathpar}
subject to the equations
\begin{mathpar}
  ur = \dom^u_\cC \and
  u\ell = \lambda^u_\cC \and
\end{mathpar}
and has as cones those making $\cC^\to$ a cotensors with the tight arrow category $2$, $\cC \comma u$ the comma
object of $1_\cC$ and $u$, $\cU \comma r$ the comma object of $1_\cU$ and $r$, $\cC^\to \comma \chi r$ the comma
object of $\cC^\to \comma \chi r$, and the cones making $\ell$ and $\chi \ell$ cartesian morphisms, i.e. the last
two diagrams above.

We also need that $\chi$ preserves the cartesian lifts, which amounts to requiring that $\chi^\to r$ is cartesian.
This is entirely algebraically characterisable by \cref{prop:cartesian by limit}.

A model for $\Comp$ in $\Cat^-$ is exactly a (cloven) comprehension category, a tight morphism of models is a
strict homomorphism of comprehension categories, and a loose morphism is a pseudo homomorphism of comprehension
categories.

Using $t : \cC \comma u \to \cU^\to$ denote the morphism induced by $u\lambda_\cU : u\dom_\cU \to u\cod_\cU$,
we see that $u$ is a discrete fibration if $rt = \dom^u_\cC$ and $\ell t = 1_{1_\cU}$, capturing that the lift
of the image of a generic morphism in $\cU$ under $u$ is that same generic morphism. Adding this morphism $t$
and the comma object and cone for $\cU^\to$ as well as these equations to the sketch for comprehension categories,
we then specify the comprehension categories whose fibration of types are discrete, also known as categories with
attributes. We denote the theory generated by this augmeneted sketch by $\Attr$, the theory of categories with
attributes.


\subsection{}

An alternative formulation of the notion of comprehension category consists of:
\begin{enumerate}
  \item a fibration $u : \cU \to \cC$, where the objects of $\cU$ are types and those of $\cC$ are contexts,
  \item a 1-cell $\set{-} : \cU \to \cC$, called the comprehension map,
  \item a 2-cell $\pi : \set{-} \to u$, corresponding to the natural projection,
\end{enumerate}
such that for $\ell : r \to \cod : \cC \comma u \to \cU^\to$ a cleavage for $u$, the morphism $\pi^\to \ell
: \cC \comma u \to \cC^\to$ is cartesian. Equivalently, this means that the following square is a pullback:
\[\begin{codi}
  \obj {|(r)| \set{r} & |(cod)| \set{\cod} \\ \dom & u\cod \\};
  \mor r \set{\ell}:-> cod \cod\pi:-> ucod;
  \mor[swap] r r\pi:-> dom \lambda:-> ucod;
\end{codi}\]

\newcommand\GNM{\mathrm{GNM}}
\section{Natural Models}
Similarly to comprehension categories, natural models are defined as certain fibrations over a base category.
Formally, they consist of a diagram in $\Cat$ of the shape:
\[\begin{codi}[hexagonal=horizontal side 6em angle 45] 
  \obj{\dot\cU &   \cU \\ & \cC \\};
  \mor  (dot cU) ["\typ",swap]:-> cU u:-> cC;
  \mor[swap] (dot cU) \dot u:-> cC;
  \mor[swap] cU \var:[bend right,->] (dot cU);
  \mor typ [shorten=0.3em, |-] var;
\end{codi}\]
where the triangle commutes, and $u, \dot u$ are discrete fibrations. These correspond to categories with
attributes, but can be generalized by asking $u, \dot u$ to be possibly non-discrete fibrations, that $\typ$
be a morphism of fibrations and $\var$ preserves cartesian morphisms (though is not necessarily a morphism of
fibrations), and that the unit and counit of the adjunction $\typ \dashv \var$ be $\dot u$-cartesian and
respectively. We shall call these diagrams generalized natural models, and we will show that they are
essentially equivalent to comprehension categories. Furthermore, as we have shown with comprehension categories,
all the data in this diagram can be specified in terms of a $\cF$-sketch, so that we have $\cF$-logics for
(generalized) natural models. We shall denote these by $\GNM$ and $\NM$ respectively.

\begin{definition}[{\cite[Definition 3.0.1]{coraglia2024a}}]
  A generalized natural model is a diagram
  \[\begin{codi}[hexagonal=horizontal side 6em angle 45] 
    \obj{\dot\cU &   \cU \\ & \cC \\};
    \mor  (dot cU) ["\typ",swap]:-> cU u:-> cC;
    \mor[swap] (dot cU) \dot u:-> cC;
    \mor[swap] cU \var:[bend right,->] (dot cU);
    \mor typ [shorten=0.3em, |-] var;
  \end{codi}\]
  in $\Cat$ for which $\typ$ and $\var$ preserve cartesian morphisms and the unit and counit of the adjunction
  $\typ \dashv \var$ are cartesian.
\end{definition}

\begin{notation}
  We use $\set{-} : \cU \to \cC$ to denote the composite $\dot u\var$, and call this the comprehension map.
  Using $\epsilon : \typ\,\var \to 1_{\cU}$ and $\eta : 1_{\dot\cU} \to \var\,\typ$ to denote the unit
  and counit of the adjunction $\typ \dashv \var$, we use $\pi : \set{-} \to u$ to denote the 2-cell
  $u\epsilon : \set{-} = \dot u\var = u\,\typ\,\var \to u$, which intuitively corresponds to the projection
  given by context extension; for $\Gamma$ a context and $\Gamma \vdash A\;\cU$ a type, we have $\pi A :
  \Gamma.A \to A$.

  We will use $\tau : \dot u \to \dot u\var = \set{\typ}$ to denote $\dot u\eta$, with the idea that this
  corresponds to the substitution $\Gamma \to \Gamma.A$, for a term $\Gamma \vdash a : A$. Note that we have
  \[
    \pi{\typ} \circ \tau = u\epsilon\typ \circ \dot u\tau = u\epsilon\typ \circ u\typ\tau =
    u(\epsilon\typ \circ \typ\tau) = 1_u,
  \]
  where the last equality holds by the one of the triangle identities of the adjunction $\typ \dashv \var$.
  This notion of terms thus aligns with the standard one of terms being sections of the context projection.

  For $f : A \to \var B : X \to \dot\cU$, we use $f^\sharp$ to denote the adjoint conjugate of $f$, defined by
  $f^\sharp = \epsilon B \circ \typ f$, and for $g : \typ A \to B$, we denote the adjoint conjungate by
  $g_\sharp = \var g \circ \eta A$. The triangle identities of the adjuntion implies that $(f^\sharp)_\sharp
  = f$ and $(g_\sharp)^\sharp = g$. We also have that $u f^\sharp = \pi B \circ \dot u f$ and $\dot u g_\sharp
  = \set{g} \circ \tau A$.
\end{notation}

\begin{proposition}
  For any $b : X \to \dot\cU$, the arrow $\eta b : b \to \var\typ b$ is monic.
\end{proposition}
\begin{proof}
  Let $f,g : a \to b : X \to \dot\cU$ be given such that $\eta b \circ f = \eta b \circ g$. Then 
  \[\dot u f = u\typ f = u(\epsilon\typ b \circ \typ\eta b \circ \typ f) = 
  u(\epsilon\typ b \circ \typ\eta b \circ \typ g) = u\typ g = \dot u g.\]
  Since $\eta$ is cartesian and $(b,a,\eta b \circ f = \eta b \circ g, \dot u f = \dot u g)$ is a certesian
  cone with both $f,g$ universal arrows, uniqueness of th euniversal arrow tells us that $f = g$.
\end{proof}

\begin{proposition}
  The map $\typ : \dot\cU \to \cU$ is faithful, in the sense that for any pair of 2-cells $f,g : a \to b
  : X \to \dot\cU$, if $\typ f = \typ g$, then $f = g$. 
\end{proposition}
\begin{proof}
  Note that
  \[\eta b \circ f = \var\typ f \circ \eta a = \var\typ g \circ \eta a = \eta b \circ g\]
  by the interchange property, so by the previous proposition we conclude $f = g$.
\end{proof}

% \begin{proposition}
%   For any 2-cell $f : A \to B : X \to \cU$, if $f$ is $u$-cartesian, then $\var f$ is $\dot u$-cartesian, and
%   for any morphism $\dot f : a \to b : X \to \dot \cU$, if $\typ \dot f$ is $u$-cartesian, then $\dot f$ is
%   $\dot u$-cartesian as well.
% \end{proposition}
% \begin{proof}
%   For the first part, suppose we are given a $\dot u$-cartesian cone over $\var f$:
%   \[\begin{codi}[tetragonal=base 5.5em height 3.5em]
%     \obj { |(Y)| Y & |(X)| X & |(A)| \dot\cU \\ & & |(B)| \cC \\};
%     \mor X ["\var B",name=x]:[->,bend left] A ["\dot u",name=p]:-> B;
%     \mor X ["\var A",name=y,swap]:[->,bend right] A;
%     \mor y \var f:[-2>] x;
%     \mor Y ["c",name=a]:[->, bend left=5em] A;
%     \mor Y ["g",name=g]:-> X;
%     \mor Y ["\dot u c",name=pa,swap]:[->, bend right=2em] B;
%     \mor[swap] a {{k}}:[-2>,slide=0.1em] X;
%     \mor[swap] pa {{l}}:[-2>,slide=0.4em, shorten=0.4em] X;
%   \end{codi}\]
%   We need to construct a unique map $h : c \to \var A g$ such that $\var f g \circ h = k$ and $\dot u h =
%   l$. Note that $\typ\var f$ is $u$-cartesian since $\epsilon B \circ \typ\var f = f \circ \epsilon A$ and
%   $\epsilon B$ are cartesian. Since furthermore $\dot u = u \typ$, we find that $u\typ k = u\typ\var fg \circ l$,
%   so there exists a unique map $\gamma : \typ c \to \typ\var B$ such that $\typ\var f g \circ \gamma = \typ k$
%   and $u\gamma = l$. We take $h$ to be the composite
%   \[c \xrightarrow{\eta c} \var\typ c \xrightarrow{\var \gamma} \var\typ\var A g \xrightarrow{\var\epsilon Ag}
%     \var Ag.\]
%   Then we have that
%   \begin{align*}
%     \typ h & = \typ(\var(\epsilon A g \circ \gamma) \circ \eta c) \\
%            & = \typ\var\epsilon A g \circ \typ\var\gamma \circ \typ\eta c \\
%            & = d
%   \end{align*}
%   \begin{align*}
%     \var f g \circ h & = \var(fg \circ \epsilon A g \circ \gamma) \circ \eta c \\
%                      & = \var(\epsilon B g \circ \typ\var fg \circ \gamma) \circ \eta c \\
%                      & = \var(\epsilon B g \circ \typ k) \circ \eta c \\
%                      & = \var\epsilon B G \circ \var\typ k \circ \eta c \\
%                      & = \var\epsilon B G \circ \eta\var Ag \circ k \\
%                      & = k
%   \end{align*}
%   Similarly, we have that $\dot u h = u\typ h = u\typ(\var\epsilon A g \circ \var\gamma \circ \eta c)
%   = u(\typ\var\epsilon A g \circ \typ\var\gamma \circ \eta c)
%   = u (\typ\var\epsilon A g \circ \eta A g \circ \gamma)
%   = u (\eta\typ\var Ag \circ $
%   Now note that $\epsilon B \circ \gamma : \typ c \to B$, 
%   .and $\epsilon B$ is cartesian
%   Since $\dot u = u\typ$, we have that $u\typ k = l \circ u\typ\var f g$, so \todo{Finish this}
% \end{proof}

\begin{lemma}
  For any $\dot u$-cartesian map $f : a \to \var A : X \to \dot \cU$, its conjugate $f^\sharp$ is $u$-cartesian,
  and for any $u$-cartesian map $g : \typ a \to A : X \to \cU$, the conjugate $g_\sharp$ is $\dot u$-cartesian.
\end{lemma}
\begin{proof}
  For $f$, note that $f^\sharp = \epsilon A \circ Tf$, so since $\epsilon$ and $f$ are cartesian and $T$
  preserves cartesian morphisms, it follows that $f^\sharp$ is cartesian as well. A similar argument shows
  that $g_\sharp$ is cartesian, using that $\var$ preserves cartesian morphisms.
\end{proof}

\begin{lemma}
  Let $f : A \to B : X \to \cU$ be a $u$-cartesian morphism. Then the following square is a pullback square:
  \[\begin{codi}
    \obj {|(eA)| \set{A} & |(eB)| \set{B} \\ uA & uB \\};
    \mor eA {{\set{f}}}:-> eB \pi B:-> uB;
    \mor[swap] eA \pi A:-> uA uf:-> uB;
  \end{codi}\]
\end{lemma}
\begin{proof}
  Consider another span $uA \xleftarrow{k} \Delta \xrightarrow{l} \set{B}$ such that $uf k = \pi B l$. We must
  show that there exists a unique map $\Delta \to \set{A}$. Let $\bar l : \bar \Delta \to \var B$ denote a
  cartesian lift of $l : \Delta \to \dot u \var B$. To construct a map $\Delta \to \set{A}$, it suffices to find
  a map $h : \bar\Delta \to \var A$, which by the $\typ \dashv \var$ adjunction is equivalent to constructing
  a map $h^\sharp : \typ\bar\Delta \to A$. Now, consider the cartesian cone
  \[\begin{codi}[tetragonal=base 5.5em height 3.5em]
    \obj { |(Y)| X & |(X)| X & |(A)| \dot\cU \\ & & |(B)| \cC \\};
    \mor X ["B",name=x]:[->,bend left] A ["u",name=p]:-> B;
    \mor X ["A",name=y,swap]:[->,bend right] A;
    \mor y f:[-2>] x;
    \mor Y ["\typ \bar\Delta",name=a]:[->, bend left=5em] A;
    \mor Y ["1_X",name=g]:-> X;
    \mor Y ["\Delta",name=pa,swap]:[->, bend right=2em] B;
    \mor[swap] a {{\bar l^\sharp}}:[-2>,slide=0.1em] X;
    \mor[swap] pa {{k}}:[-2>,slide=0.2em, shorten=0.2em] X;
  \end{codi}\]
  where $\bar l^\sharp$ is the adjoint of $\bar l$. Note that we have
  \[u(\bar l^\sharp) = u\epsilon B \circ u\typ\bar l = \pi B \circ \dot u\bar l = \pi B \circ l = uf \circ k,\]
  so that this is indeed a cartesian cone. The universal property of $f$ now gives us a unique map $h^\sharp
  : \typ\bar\Delta \to A$ such that $uh^\sharp = k$ and $f \circ h^\sharp = \bar l^\sharp$. Furthermore, this
  map is cartesian, since $f$ and $\bar l^\sharp$ are. We claim that, taking $h = (h^\sharp)_\sharp$, the map
  $\dot u h$ is the universal map $\Delta \to \set{A}$. Thus we need to show that $\pi A \circ \dot u h =
  k$ and $\set{f} \circ \dot u h = l$. For the former, we compute
  \[
    \pi A \circ \dot u h = \pi A \circ \set{h^\sharp} \circ \tau \bar\Delta
    = uh^\sharp \circ \pi \bar\Delta \circ \tau\bar\Delta = uh^\sharp = k,
  \]
  and for the latter we have that
  \[
    \set{f} \circ \dot u h = \set{f \circ h^\sharp} \circ \tau\bar\Delta = \set{\bar l^\sharp} \circ
    \tau\bar\Delta = u(\bar l^\sharp)_\sharp = u\bar l = l.
  \]
  
  Finally, we must show that $uh$ is unique with these properties, so suppose $h' : \Delta \to \set{A}$ were
  another map with $\pi A \circ h' = k$ and $\set{f} \circ h' = l$, and let $\bar h' : \bar\Delta' \to \var A$
  denote a cartesian lift of $h'$. Then $\var f \circ h'$ is cartesian over $l$, so by essential uniqueness of
  cartesian lifts, there exists a vertical isomorphism $\alpha : \bar\Delta \cong \bar\Delta'$ such that $\var
  f \circ h' \circ \alpha = \bar l$, and since isomorphisms are cartesian, we find that $h' \circ \alpha : \bar
  \Delta \to \var A$ is cartesian, and so equal to $h$ by again by uniqueness of cartesian lifts. Therefore $u
  \bar h' = u (\bar h' \circ \alpha^{-1}) = uh$, as desired.
\end{proof}

\begin{proposition}
  Let $\sigma : \Delta \to \Gamma : X \to \cC$, $A : X \to \cU$, and $a : X \to \dot\cU$ with $uA = \Gamma$
  and $\typ a = A[\sigma]$ be given. Then the map $\var\bar\sigma \circ \eta a$ is cartesian, where $\bar
  \sigma$ is the cartesian lift of $\sigma$ given by the cleavage. We denote $\dot u(\var\bar\sigma \circ
  \eta a)$ by $(\sigma,a)$.
\end{proposition}
\begin{proof}
  Since $\var$ preserves cartesian morphisms, $\eta$ and $\bar\sigma$ are cartesian, and cartesian morphisms
  compose, this us true.
\end{proof}


\begin{proposition}
  The map $\Sigma$ is comonadic.
\end{proposition}

\begin{proposition}
  Let $A : X \to \cU$ and $t : uA \to \set{A}$ be given such that $\pi A \circ t = 1_{uA}$. Then there exists
  a term $\bar t : X \to \dot\cU$, unique up to isomorphism, with $\typ \bar t = A$ such that $t = \tau\bar t$.
\end{proposition}
\begin{proof}
  We show that $\bar t = (\var A)[t] : X \to \dot\cU$ suffices. First note that this candidate is well-defined
  since $\dot u\var A = {A}$. Let $\kappa : (\var A)[t] \to \var A$ denote the cartesian lift of $(t : uA
  \to \set{A}, \var A)$. We must first show that $\tau\bar t = t$, but we have $\tau\bar t = \dot u\eta((
  \var A)[t])$.
\end{proof}
\begin{corollary}
  The following is a pullback square in $\NM$:
  \[\begin{codi}
    \obj {\dot\cU & \cC^S \\ \cU & \cC^\to \\};
    \mor (dot cU) {{(\tau,\pi\typ)}}:-> (cC ^S) \cC^g:-> (cC ^to);
    \mor[swap] (dot cU) \typ:-> cU (\pi):-> (cC ^to);
  \end{codi}\]
  where $\cC^S$ is the cotensor with $S$ the walking section. Concretely, $S$ consists of two tight objects
  $s,t \in S$ and morphisms $f : x \to y$ and $g : y \to x$ with $gf = 1_x$.  
\end{corollary}
\begin{proof}
  Suppose we are given $A : X \to \cU$ and $\sigma : X \to \cC^S$ such that $(\pi)A = \cC^g \sigma$. By the
  universal property of $\cC^S$, we know that $s = (t, p)$ with $t : \Gamma \leftrightarrow \Delta : p$ and
  $p t = 1_{\Gamma}$. From $(\pi)A = \cC^g \sigma$, we find that $\Gamma = uA$, $\Delta = \set{A} = \Gamma.A$
  and $p = \pi A$. By the previous proposition we then have a unique term $\bar t : X \to \dot\cU$ with
  $\typ \bar t = A$ and $\tau\bar t = t$. In particular, we 
\end{proof}
\todo{I think this is true, though it needs more careful checking.}

\begin{proposition}
  The logics $\GNM$ (resp. $\NM$) and $\Comp$ (resp. $\Attr$) are equivalent as $\cF$-categories.
\end{proposition}
\todo{Consider going through weakening-contraction comonads?}
\begin{proof}
  We first construct the $\cF$-functor $F : \Comp \to \GNM$, for which it suffices to construct a model of
  $\Comp$ inside $\GNM$. We keep the fibration of types the same, so we only need to find a map $\chi : \cU \to
  \cC^\to$ such that $\chi^\to \ell$ is $\cod$-cartesian, where $\ell : r \to \cod : \cC \comma u \to \cU$ is the
  cleaveage for $u$. Let $\chi$ be the universal map induced by $\pi : \set{-} \to u$. To see that $\chi^\to\ell$
  is $\cod$-cartesian, it suffices to show that the square
  \[\begin{codi}
    \obj {|(r)| \set{r} & |(cod)| \set{\cod} \\ \dom & u\cod \\};
    \mor r \set{\ell}:-> cod \pi\cod:-> ucod;
    \mor[swap] r \pi r:-> dom \lambda:-> ucod;
  \end{codi}\]
  is a pullback.

  In the other direction we require a $\cF$-functor $G : \NM \to \Attr$, so we construct a model of $\NM$
  inside $\Attr$. As this construction is quite a bit more involved, we will start by laying out some basic
  notation. Since we will deal with both the arrow object $\cC^\to$ and the comma object $\cC \comma u$, we
  need to distinguish their universal cones. We write $\lambda : \dom \to u\cod : \cC \comma u \to \cC$ for
  the universal cone belonging to $\cC\comma u$ and $\lambda' : \dom' \to \cod' : \cC^\to \to \cC$ for the
  universal cone for $\cC^\to$. We write $e \coloneq \dom'\chi$ and $q \coloneq \lambda' \chi : e \to u :
  \cU \to \cC$, and for a generalized element $A : X \to \cU$, will write $\Gamma \vdash A$ to denote that
  $\Gamma \coloneq uA$. Furthermore, we write $\Gamma.A$ for $eA$. By the construction of $\Attr$, we have
  a fixed cleavage $(r,\ell)$ showing that $u$ is a fibration, where $r : \cC \comma u \to \cU$ is such
  that $ur = \dom$ and $\ell : r \to \cod : \cC\comma u \to \cU$ is $u$-cartesian with $u\ell = \lambda$.
  Furthermore, we have that $\chi\ell : \chi r \to \chi\cod$ is $\cod$-cartesian, since that is how we capture
  that $\chi$ preserves cartesian-ness of the cartesian lifts for $u$.

  We will start with constructing the object of terms $\dot\cU$. Intuitively, the terms over a context
  $\Gamma : X \to \cC$ ought to be sections to some context projection $q A$ for some $\Gamma \vdash A$,
  and we encode this as a pullback. First we need an object of sections, however. Let $S$ denote the tight
  walking section (an object of $\cF$), so it has two tight objects $s,t \in S$ and morphisms $f : x \to y$
  and $g : y \to x$ with $gf = 1_x$. The power object $\cC^S$ consists of sections in $\cC$, in the sense
  that any map $X \to \cC^S$ is the same data as a section in the $\cF$-category $X \to \cC$. Now the object
  of terms is defined as the pullback
  \[\begin{codi}
    \obj {\dot\cU & \cC^S \\ \cU & \cC^\to \\};
    \mor (dot cU) p:-> (cC ^S) \cC^g:-> (cC ^to);
    \mor[swap] (dot cU) \typ:-> cU \chi:-> (cC ^to);
  \end{codi}\]
  where $\cC^g : \cC^S \to \cC^\to$ is the projection induced by inclusion $g : 2 \to S$ in $\cF$. We next
  define $\dot u = u\typ$, as that is a required equation for $\dot\cU$ to be a fibration of terms in
  a natural model. We will use $\Gamma \vdash a : A$ to denote an generalized element $a : X \to \dot\cU$,
  with $A = \typ a$ and $\Gamma = uA$. Thus if we have an element $\Gamma \vdash a : A$, we also have
  $\Gamma \vdash A$ and $\Gamma : X \to \cC$.

  To show that $\dot u$ is a fibration, we need for every $\Gamma \vdash a : A$ and $\typ : \var \to
  \Gamma : X \to \cC$ a term $\var \vdash a[\typ] : A[\typ]$, where $\Gamma \vdash A[\typ]$ is
  $r(\typ,A)$. Using $\bar a : \Gamma \to \Gamma.A$ to denote the section of $q\typ$ induced by $p$,
  we see that we require a section $\bar a[\typ] : \var \to \var.A[\typ]$ to $qA[\typ]$.
  Since $\chi\epsilon(\typ,A) : \var.A[\typ] \to \Gamma.A$ is cartesian, we find that the following
  square is a pullback:
  \[\begin{codi}[tetragonal=base 8em height 4.5em]
    \obj {|(tl)| \var.A[\typ] & |(tr)| \Gamma.A \\ |(bl)| \var & |(br)| \Gamma\\};
    \mor tl {{e\epsilon(\typ,A)}}:-> tr qA:-> br;
    \mor[swap] tl {{qA[\typ]}}:-> bl \typ:-> br;
  \end{codi}\]
  Since $qA \circ \bar a = 1_\Gamma$, we have that $\typ \circ 1_{\var} = qA \circ \bar a\typ$, which
  induces a universal morphism $\bar a[\typ] : \var \to \var.A[\typ]$ which satisfies $qA[\typ]
  \circ \bar a[\typ] = 1_{\var}$, as desired. Now the pair $(\bar a[\typ], qA[\typ])$ constitutes a
  morphism $pa[\typ] : X \to \cC^S$ such that $\cC^g pa[\typ] = \chi A[\typ]$, which means we have
  a morphism $a[\typ] : X \to \dot\cU$ with $\typ a[\typ] = A[\typ]$ and $p a[\typ]$ as just
  defined. We also require a cartesian 2-cell $\dot \epsilon (\typ,a) : a [\typ] \to a$. \todo{Show that
  this exists.}


  Next we require a right adjoint $\var$ to $\typ$. This requires us to find maps $w : \cU \to \cU$ and
  $v : \cU \to \cC^S$ such that $\chi w = \cC^g v$. Let $\bar q : \cU \to \cC \comma u$ denote the universal
  map induced by $q : e \to u1_\cU : \cU \to \cC$, so that $\lambda\bar q = q$. Take $w = r\bar q : \cU \to
  \cU$. Since $\chi\ell\bar q : \chi r\bar q \to \chi\cod\bar q = \chi$ is $\cod$-cartesian, we have the
  following pullback square in $\cU \to \cC$
  \[\begin{codi}[tetragonal=base 6em height 4.5em]
    \obj {er\bar q & |(e1)| e \\ |(e2)| e & u \\};
    \mor (erbar q) -> e1 -> u;
    \mor[swap] * -> e2 -> *;
  \end{codi}\]
  where the left map is $\lambda'\chi r\bar q = qr\bar q$, the right map is $\lambda'\chi = q$, the top map
  is $\dom'\chi\ell\bar q = e\ell\bar q$, and the bottom map is $\cod'\chi\ell\bar q = u\ell\bar q = \lambda
  \bar q = q$. But since the square is a pullback, we have a map $v_1 : e \to er\bar q$ induced by $(1_e, 1_e)$
  with the property that $qr\bar q \circ v = 1_e$. Thus we have an induced map $v = (v_1,v_2) : \cU \to \cC^S$
  where $v_2 = r\bar q$, and so also $\lambda'\cC^g v = v_2$, so that $\cC^g v = \chi r\bar q = \chi w$, as
  desired. Thus we have an induced map $\var$ with $\typ\var = w = r\bar q$ and $p\var = v$.
  
  \todo{Show that $\var$ is a a right adjoint to $\typ$.}
\end{proof}

\section{Inductive Types}
\subsection{The empty type}
The empty type $\bzero$ is generally given by the following rules:
\begin{mathpar}
  \infer{\Gamma \ctx}{\Gamma \vdash \bzero}
  \and
  \infer{\Gamma.\bzero \vdash A\;\cU}{\Gamma.\bzero \vdash \ind_\bzero(A) : A}
\end{mathpar}
We translate these as loose morphisms $\bzero : \ctx \to \ty$ and $\ind_\bzero : \ctx \pb[(e\bzero,\bzero)]{
(\rty \times \typ)} (\ty \times \tm) \to \tm$ such $\typ \ind_\bzero = r_{\ty}$that the following square commutes:
  \[\begin{codi}[tetragonal=base 8em height 5em]
    \obj {|(tl)| \ctx \pb[(1_{\ctx}.\bzero,\bzero)]{(\rty \times \typ)} (\ty \times \tm) & |(tr)| \tm \\
    |(bl)| \ctx \pb[1]{2} & |(br)| \ty \\};
\end{codi}\]
\todo[inline]{Maybe consider conclusions as being a pullback of the premise, and then the rule as a section of the induced
morphism?}

The computation rules are encoded as equalities on the morphisms.


% \renewcommand\Box{□}
% \newcommand\Ind{\operatorname{\mathrm{Ind}}}
% \subsection{Non-recursive inductive types}

\subsection{Data types as Dialgebras}
We will assume that we have dependent sum types, as described earlier.

\begin{lemma}
  Let $A, B : X \to \cU$ with $uA = uB$ be given. Then there is a correspondence between maps
  $\alpha : \set{A} \to \set{B}$ such that $\pi B \alpha = \pi A$ and maps $\beta : \set{A} \to
  \set{B[\pi A]}$ such that $\pi(B[\pi A]) \circ \beta =  1_{A}$.
\end{lemma}
\begin{proof}
  Consider the diagram
  \[\begin{codi}
    \obj {|(cA)| \set{A} \\ & |(cBpiA)|\set{B[\pi A]} & |(cB)| \set{B} \\
                            & |(cA2)| \set{A} & uB \\
    };
    \mor cA \alpha:[bend left=5em,->,dotted] cB;
    \mor[swap] cA {{1_{\set{A}}}}:[bend right=5em,->] cA2;
    \mor cBpiA {{\set*{\vphantom{\big\vert}\overline{\pi A}}}}:-> cB \pi B:-> uB;
    \mor[swap] cBpiA {{\pi B[\pi A]}}:-> cA2 \pi A:-> uB;
    \mor cA \beta:->,dashed cBpiA;
  \end{codi}\]
  Recall that the square to the bottom right is a pullback square,  so that given $\alpha$, such a map $\beta$
  is uniquely determined, and vice versa.
\end{proof}

\begin{definition}
  A \emph{data type signature} with parameters $p : P \to \cC$ is a tuple $(F,\phi)$ where
  $A$ is a 1-cell $\bP \pb[p]{u} \cU \loose \cC^n$ and $\alpha$ is a 2-cell $F \to \delta^n u$, where
  $\delta^n : \cC \to \cC^n$ is the diagonal map.

  An algebra for a signature $(F,\phi)$ is a map $A : X \to P \pb[p]{u} \cU$ and a 2-cell $a : FA \to 
  \delta^n\set{\pi_2A}$, such that $\alpha A = \delta^n\pi \pi_2A \circ a$, and an algebra homomorphism
  $(A,a) \to (B,b)$ is a 2-cell $f : A \to B$ such that $\delta^n\set{\pi_2 f} \circ a = b \circ F f$.
\end{definition}

\begin{remark}
  For a fixed signature $(F,\phi)$, we can using only finite $\cF$-weighted limits construct an object
  of algebras $(F,\phi)\Alg$, such that any $(F,\phi)$-algebra is the same as a map into $(F,\phi)\Alg$,
  and vice versa. This object comes equipped with a universal $(F,\phi)$-algebra, with underlying map
  $R_{(F,\phi)} : (F,\phi) \Alg \to P \pb[u]{p} \cU$ and 2-cell $\rho : F R_{(F,\phi)} \to \delta^n\set
  {R_{(F,\phi)}}$.
\end{remark}

We want an inductive type over a signature $(F,\phi)$ to be an inital algebra. Since this works over
aribtary parameters, this means we require an assignment 

\begin{definition}
  An inductive type for a signature $(F,\phi)$ is a map $\mu(F,\phi) : P \to (F,\phi)\Alg$ such that
  $\pi_1 R_{(F,\phi)} \mu(F,\phi) = 1_P$ and for every $A : X \to (F,\phi)\Alg$, there exists a unique
  map $h : \mu(F,\phi)\pi_1R_{(F,\phi)} A \to A$ such that $\pi_1R_{(F,\phi)} h = 1_{\pi_1R_{(F,\phi)}A}$
\end{definition}
\begin{lemma}
  Let a signature $(F,\phi)$ and $\mu(F,\phi) : P \to (F,\phi)\Alg$ be given. Then the following are equivalent:
  \begin{enumerate}
    \item $\mu(F,\phi)$ is an inductive data type.
    \item $\mu(F,\phi)$ is left adjoint to $\pi_1 R_{(F,\phi)} : (F,\phi)\Alg \to P$ with identity unit.
  \end{enumerate}
\end{lemma}
\begin{proof}
  For $1 \implies 2$, note that by taking $A = 1_{(F,\phi)\Alg}$, we see that there exists a unique map $
  \epsilon : \mu(F,\phi)\pi_1R_{(F,\phi)} \to 1_{(F,\phi)\Alg}$ such that $\pi_1 R_{(F,\phi)}\epsilon =
  1_{\pi_1 R_{(F,\phi)}}$. Thus it only remains to show that $\epsilon\mu(F,\phi) = 1_{\mu(F,\phi)}$. But
  there exists by uniqueness only one map $h : \mu(F,\phi)\pi_1R_{(F,\phi)}\mu(F,\phi) = \mu(F,\phi) \to
  \mu(F,\phi)$ such that $\pi_1 R_{(F,\phi)} h = 1_{\pi_1 R_{(F,\phi)}\mu(F,\phi)} = 1_{1_{(F,\phi)\Alg}}.$
  Since the identity map $1_{\mu(F,\phi)}$ and $\epsilon\mu(F,\phi)$ both satisfy this property, we conclude
  that they are the same, thereby establishing that $\epsilon$ is the counit of an adjunction $\mu(F,\phi)
  \dashv \pi_1R_{(F,\phi)}$ with identity unit.

  For $2 \implies 1$, let $A : X \to (F,\phi)\Alg$ be given. Clearly $\epsilon A$ is a map $\mu(F,\phi)\pi_1
  R_{(F,\phi)}A \to A$ satisfying the desired property, so it remains to show that this map is unique. To that
  end, let $h : \mu(F,\phi)\pi_1R_{(F,\phi)}A \to A$ be given such that $\pi_1R_{(F,\phi)}h = 1_{\pi_1R_{(F,
  \phi)}A}$. Note that
  \[\epsilon A \circ \mu(F,\phi) \pi_1 R_{(F,\phi)} h = h \circ \epsilon \mu(F,\phi)\pi_1 R_{(F,\phi)}A = h,\]
  but $\pi_1 R_{(F,\phi)} h = 1_{\pi_1 R_{(F,\phi)}}$, so we see that
  \[\epsilon A = \epsilon A \circ \mu(F,\phi)\pi_1 R_{(F,\phi)} h = h,\]
  as desired.
\end{proof}

\begin{remark}
  The data types described here satisfy the $\eta$-rule, since $\epsilon\mu(F,\phi) = 1_{\mu(F,\phi)}$. We could
  drop this property by asking for a weakly initial object, rather than an initial object. This would be removing
  the uniqueness requirement from the definition of an inductive data type, or equivalently asking for a map
  $\epsilon : \mu(F,\phi)\pi_1R_{(F,\phi)} \to 1_{(F,\phi)\Alg)}$ such that $\pi_1 R_{(F,\phi)}\epsilon =
  1_{\pi_1R_{(F,\phi)}}$.
\end{remark}

\begin{example}[Empty type]
  The empty type has no parameters, meaning we take $p = 1_\cC : \cC \to \cC$, and no constructors. Thus we
  take $F$ to be the unique map into the 2-terminal object, and $\phi$ is trivially determined by this.
  We use $\bot = \mu(F,\phi)$ to denote this inductive type. 

  An algebra for $(F,\phi)$ is simply a type $A : X \loose \cU$ (up to isomorphism), and the universal property
  then always gives us a map $\set{\bot uA} \to \set{A}$, which we interpret to say that for any context
  containing $\bot$, we have an element of any type.
\end{example}

\begin{example}[Unit type]
  The unit type also has no parameters, so $p = 1_\cC : \cC \to \cC$. It has exactly one constructor, and
  this constructor takes no arguments. Thus we take $F = p\pi_1$ and $\phi = 1_{p\pi_1}$. We denote the
  inductive type for this signature by $\top$.

  An algebra for $(F,\phi)$ is a type $A : X \to \cU$ with a substitution $a : uA \to \set{A}$ such that
  $\pi A \circ a = 1_{uA}$, i.e.\ a term of type $A$. We use $\top$ also to denote the underlying type
  $\pi_2 R_{(F,\phi)}\top$ of the initial algebra. The constructor $* : u\top \to \set{\top}$ is the map
  given by the algebra, formally $\pi_2 \rho_{(F,\phi)}$. The universal property then gives us a map
  $\set{\pi_2R_{(F,\phi)}\epsilon A} : \set{\top uA} \to \set{A}$ such that $\set{\pi_2 R_{(F,\phi)}\epsilon A}
  \circ * = a \circ p\pi_1R_{(F,\phi)}\epsilon A = a$, which is exactly the
  $\beta$-rule.
\end{example}

\begin{example}[Binary sum types]
  Two constructors, $P = \cU \pb[u]{u} \cU$, $p = u\pi_1 = u\pi_2$, $F_1 = \set{\pi_1\pi_1}$, $F_2 =
  \set{\pi_2\pi_1}$. 
\end{example}

\begin{example}[Natural numbers]
  No parameters, so $p = 1_\cC : \cC \to \cC$. Two constructors, the first with no arguments, so take
  $F_1 = u\pi_2 = p\pi_1$, and the second with one, so take $F_2 = \set{\pi_2}$. An algebra is a type
  $A : X \to \cU$ with two substitutions, $a_z : uA \to \set{A}$ and $a_s : \set{A} \to \set{A}$.
  The initial algebra is a type $\bN : \cC \to \cU$ with two constructors $z : 1_\cC \to \set{\bN}$ and
  $s : \set{\bN} \to \set{\bN}$, and the eliminator into $A$ gives $\epsilon A : \bN \to A$ such that
  $\set{\pi_2 \epsilon A} \circ s = a_s \circ \set{\pi_2 \epsilon A}$ and $\set{\pi_2 \epsilon A} \circ z
  = a_z$.
\end{example}

\begin{example}[W-types]
  Suppose the theory has function types, whose type former we denote by $Fun : \cU \pb[u]{u} \cU \to \cU$.
  $W$-types are parameterized by a type $A$ and a family $B$ indexed over the type. Thus we take $P = (\cU
  \pb[\set{-}] {u} \cU)$ and $p = u\pi_1$. It has a single constructor, so $F : P \pb[p]{u} \cU \to \cC$,
  and this constructor takes an element of the first type $A$ and, letting $X = \pi_2$, a map $Fun(B, X[
  \pi A]$. Thus we take $F = \set{Fun(\pi_2\pi_1, r(\pi\pi_1\pi_1, \pi_2)}$, where $r : \cC \comma u \to
  \cU$ is the lifting map for the fibration $u$ and $(\pi\pi_1\pi_1, \pi_2) : P \pb[p]{u} \cU \to \cC
  \comma u$ is the map induced by the 2-cell $\pi\pi_1\pi_2 : \set{\pi_1\pi_1} \to u\pi_1\pi_1 = u\pi_2$.
\end{example}

\todo{Find better notation than the pointfree style used here. Also, $\pi_i$ is maybe a bad choice for the
projections.}

The one thing missing now is the general induction principle, which is where we require dependent sum types.
Consider the induction rule for natural numbers:
\[\infer{\Gamma.\bN \vdash B\;\cU \\ b_z : \Gamma \to \Gamma.B[z] \\ \pi B[z] \circ b_z = 1_\Gamma \\
  b_s : \Gamma.\bN.B  \to \Gamma.\bN.B \\ \pi B \circ b_s = s \circ \pi B}
  {\Gamma.\bN\vdash \elim(B,b_z,b_s) : B}\]
Using dependent sum types, we can change the premise for the successor to be a map $b_s' : \Gamma.\sum_\bN B
\to \Gamma.\sum_\bN B$ such that $\pi(\sum_\bN B) \circ b_s' = \pi(\sum_\bN B)$ and $\mathtt{fst} \circ b_s'
= s \circ \mathtt{fst}$. Similarly, we can change the premise for the zero case to be $b_z' : \Gamma \to
\Gamma.\sum_\bN B$ such that $\pi(\sum_\bN B) \circ b_z' = 1_\Gamma$ and $\mathtt{fst} \circ b_z' = z$.
Effectively then, this depedent algebra $B$ over $\bN$ is equivalent to an algebra $b'$ on $\sum_\bN B$,
so a map $b' : F(\sum_\bN B) \to \set{\sum_\bN B}^n$, such that $\fst^n \circ b' = a' \circ F\fst$, i.e.
such that $\fst$ is an algebra homomorphism.



% \todo{Talk about induction principle and the use of $\Sigma$-types.}

% \subsection{Non-recursive inductive types}\todo{Figure out which maps are loose vs.\ tight.}
% We capture the type formers of inductive types with parameters as fibred maps over $\cC$, in the sense that for
% parameters in context $p : P \to \cC$, we let the type formation rule be a morphism $T : P \to \cU$ to subject
% to the equation $uT = p$. Thus we model the formation rule as a judgement.
% \[\infer{\Gamma \vdash x\;P}{\Gamma \vdash T(x)\;\cU}\]
% for a type $T$ by a map $T : \cC \to \cU$ with $uT = 1_\cC$. Constructor $c(\bar a) : T$ with arguments
% $\bar a : \bar A$ can be viewed as terms given by an inference rule
% \[\infer{\Gamma \vdash x \; P}{\Gamma.\bar a(x) \vdash c : T(x)}\]
% We will consider terms as certain substitution, and in particular the constructors as substitutions of a special
% form. Taking the arguments of the constructor $c$ to be a map $A : P \to \cC$ equipped with a 2-cell $\alpha : A
% \to p$ (generally some form of weakening from an extended context $A$), we take $c$ to be a 2-cell $A \to eT$
% satisfying $q c = \alpha$, where $q : eT \to uT$ is the projection.
%
% Combining all of this, given a non-recursive inductive type $T$ with constructors $c_i(A_i) : T$, over some
% parameter judgement $p : P \to \cC$, we model the introduction rule as a map $T : P \to \cU$ with $p = uT$
% and the constructors as maps $c_i : A_i \to eT$ subject to the equation $qT \circ c_i = \alpha_i$, where
% $A_i : P \to \cC$ and $\alpha_i : A_i \to p$ are given for the specific inductive type $T$.
% % We further require these arguments to
% % only extend the context, so that $a_i$ cannot be for example the empty context. We
% % capture this by asking each $\alpha_i$ to be a section.
% \todo{Consider whether it is better for the constructors to be terms, which makes dealing with them in type
% formers more complex, or as substitutions, making the $\eta$-rule and $\beta$-rule less natutal.}
%
% The only missing feature (besides recursion) is the eliminator. For an inductive type given as earlier, the
% eliminator should be a rule of the form
% \[\infer{\Gamma.T \vdash B \\ A_1 \vdash b_1 : B[(\alpha_1,c_1)] \\ \cdots \\ A_n \vdash b_n : B[(\alpha_n,c_n)]}
% {\Gamma.T \vdash \elim(B,b_1,\dots,b_n,t) : B}\]
%
% Each premise for a constructor $c_i$ is a term $A_i \vdash b_i : B[(\alpha_i,c_i)]$, and so can be described as
% by a pullback
% \[\begin{codi}
%   \obj {\cP_i & \dot\cU \\ \cU_{/T} & \cU \\};
%   \mor (cP _i) -> (dot cU) \typ:-> cU;
%   \mor[swap] (cP _i) B_i:-> (cU _{/T}) t:-> cU;
% \end{codi}\]
% Then the premise $\cP$ of the full rule is given by the wide pullback of the maps $B_i : \cP_i \to \cU_{/T}$.
% The conclusion is a term, so a morphism $\elim : \cP \to \dot\cU$, satisfying $\typ\elim = (\cP \to \cU{/T}
% \xrightarrow{t} \cU)$.
%
% To capture the $\beta$-rule, we simply add for each $i$ the equation $\elim(b_i)_i [\tau c_i] = b_i[\tau c_i]$,
% where we use $b_i : \cP \to \dot\cU$ to denote the composite projection $\cP \to \cP_i \to \dot\cU$.

% \vspace{1em}
% \todo{The following is wrong, but I don't want to remove it quite yet.}
% describe the formation and
% introduction rules by a diagram
% \[\begin{codi}[]
%   \obj {|(As)| \prod_{i = 1}^n A_i & \cC & \cU \\ \dot\cU^n & & \cU^n \\};
%   \mor As {{\seq{a_i}}}:-> cC T:-> cU \delta^n:-> (cU ^n);
%   \mor[swap] As {\prod_{i} c_i}:-> (dot cU ^n) \typ^n:-> (cU ^n);
% \end{codi}\]
% wher $\prod_{i} A_i$ denotes the wide pullback of the maps $a_i : A_i \to \cC$, $\seq{a_i}$ denotes the canonical
% map $\prod_i A_i \to \cC$, $\prod_i c_i$ denotes the fibred product of maps $c_i : A_i \to \dot\cU$, $\delta^n$
% denotes the fibred diagonal $\cU \to \cU^n$, and $\typ^n$ denotes the $n$-fold fibred product of $\typ :
% \dot\cU \to \cU$.
%
% The eliminator is trickier. Given a type former $T$ and consturctors $c_i : A_i \to T$, recall that the rule is
% essentially of the form
% \[\infer{\Gamma.T \vdash B \\ a_1 \vdash b_1 : B(c_1) \\ \cdots \\ a_n \vdash b_n : B(c_n) \\
%   \Gamma \vdash t : T}{\Gamma \vdash \elim(B,b_1,\dots,b_n,t) : B(t)}\]
% The first step is to capture the judgement $\Gamma.T \vdash B$. This is a simpl
% Given $T : \cC \to \cU$ and $(c_i : A_i \to \cU)_{i = 1}^n$ as above, we can form
% the judgement of types dependent on $T$ by the pullback
% \[\begin{codi}
%   \obj {\cU_{/T} & \cU \\ |(cC1)| \cC & |(cC2)| \cC \\};
%   \mor (cU _{/T}) t:-> cU u:-> cC2;
%   \mor[swap] (cU _{/T}) \gamma:-> cC1 eT:-> cC2;
% \end{codi}\]
%
% For the constructors, note that we have a map $\sub : \cU \pb[u]{e\typ} \dot\cU \to \cU$ corresponding to the
% rule
% \[\infer{\Gamma.A \vdash B\;\cU \\ \Gamma \vdash a : A}{\Gamma \vdash B(a)\;\cU}\]
% Since $\typ c_i = T a_i$ and $ut = e\typ$, we have a map $(t \times c_i) : \cU/T \pb[\gamma]{a_i} A_i
% \to \cU \pb[u]{e\typ} \dot\cU$, and so $\sub(t \times c_i) : \cU/T \pb[\gamma]{a_i} \to \cU$. We require the
% argument to be a term of this type, which we capture by the pullback
% \[\begin{codi}[tetragonal=base 8em height 4.5em]
%   \obj {|(1)| \dot\cU/c_i & |(2)| \dot\cU \\ |(3)| \cU/T \pb[\gamma]{a_i} A_i & |(4)| \cU \\};
%   \mor       1 \bar t_i:-> 2 \typ:-> 4;
%   \mor[swap] 1 {{(\tau_i,\alpha_i)}}:-> 3 {{\sub(t \times c_i)}}:-> 4;
% \end{codi}\]
%
% The term of type $T$ we capture by the pullback
% \[\begin{codi}
%   \obj {\dot\cU_T & \dot\cU \\ \cC & \cU \\};
%   \mor (dot cU _T) k:-> (dot cU) \typ:-> cU;
%   \mor[swap] (dot cU _T) f:-> cC T:-> cU;
% \end{codi}\]
%
% Combining all of these together, we capture the dependent type and constructors of the premises of the
% elimination rule as the wide pullback of the arrows $\tau_i : \dot \cU/c_i \to \cU/T$, so that each premise
% corresponding to a constructor is the same dependent type substituted in the corresponding constructor. Denoting
% this pullback by $P$, we then take the complete premise of the rule to be the pullback of $\gamma\tau$ and
% $f$, where $\gamma\seq{\tau_i}$ denotes the canonical arrow $P \to \cC$ taking the underlying context of the rule.
%
% Finally, the conclusion of the rule is $\dot\cU$, so that the rule is a map $\elim : P \pb[\gamma\seq{\tau_i}]{f}
% \dot\cU_T \to \dot\cU$ subject to the equation $\typ\dot\cU = \sub(\seq{\tau_i}, k)$, where $(t\seq{\tau_i}
% \times k) : P \pb[\gamma\seq{\tau_i}]{f} \dot\cU_T \to \cU \pb[u]{e\typ}\dot\cU$ is the unique map induced by
% the equation
% \[ut\seq{\tau_i}\pi_1 = eT\gamma\seq{\tau_i}\pi_1 = eTf\pi_2 = e\typ k\pi_2.\]
%
% The computation rules, one for each constructor $c_i$, use the same object $P$, but rather than $\dot\cU_T$ have
% the argument $A_i$. The rule
% \[\infer{\Gamma.A \vdash B\;\cU \\ a_1 \vdash b_1 : B(c_1) \\ \cdots \\ a_n \vdash b_n : B(c_n) \\ a_i \vdash
% c_i : T(a_i)}{\elim(B,b_1,\dots,b_n, c_i) = b_i}\]
% is captured by an equality
% \[\elim(P \times \bar c_i) = \bar t_i\pi_1,\]
% where $\bar c_i : A_i \to \dot\cU_T$ is the map induced by $\typ c_i = T a_i$ and $P \times \bar c_i :
% P \pb[\gamma\seq{\tau_i}]{} A_i$. \todo{Something is missing here}
%
% Consider an endomap $F : \cU \to \cU$ over $u$ (so that $uF = u$ and such that $F$ preserves cartesian lifts as
% cartesian). We then have an object of $F$-algebras, namely the inserter of $F$ and $1_\cU$, with the universal
% properrty that any $F$-algebra $\alpha : Fa \to a : X \to \cU$ corresponds to a unique map $\tilde a : X \to
% F\Alg$, and any morphism of $F$-algebras $h : (a, \alpha) \to (b, \beta)$ corresponds to a unique morphism
% $\tilde h : \tilde a \to \tilde b$. 
%
% \begin{lemma}\label{lem:algebra as term}
%   There is an isomorphism over $\cU$ between $U_F : F\Alg \to \cU$ and the left leg in the pullback
%   \[\begin{codi}
%     \obj {P & \dot\cU \\ |(U1)| \cU & |(U2)| \cU \\};
%     \mor P t:-> (dot cU) \typ:-> U2;
%     \mor[swap] P U:-> U1 r\bar qF:-> U2;
%   \end{codi}\]
% \end{lemma}
% \begin{proof}
%   
% \end{proof}
%
% \begin{lemma}
%   For any $F : \cU \to \cU$ an endomap of fibrations $u \to u$, the $\cF$-algebras are stable under substitution,
%   in the sense that the composite $uU_F : F\Alg \to \cC$ is a fibration.
% \end{lemma}
% \begin{proof}
%
% \end{proof}
%
% An inductive type of signature $F$ should then correspond to an $\cF$-algebra over every context $\Ind_F : \cC
% \to F\Alg$, with the underlying type $U_F \Ind_F : \cC \to \cU$ corresponding to type former, and the algebra
% structure on $U_F \Ind_F$ corresponding to the introduction rules. This structure should be invariant under
% substitutions, in the sense that for any there exists a specified isomorphism $\alpha : r_F(\cC \comma \Ind_F)
% \cong \Ind_F\dom$, where $\cC \comma \Ind_F : \cC \comma uU_F\Ind_F \to \cC \comma uU_F$ is
% the map of comma objects induced by composition with $\Ind_F$ in the second component and $r_F : \cC \comma
% uU_F \to F\Alg$ is lifting map from $uU_F$ being a fibration. We also ask that $U_Fr_F = r$, where $r$ is the
% domain of the lifting map for $u$. Furthermore, the algebra $\Ind_F$ should be initial in an appropriate sense.
% Namely, we want an algebra homomorphism $\epsilon : \Ind_F uU_F \to 1_{F\Alg}$, the recursor, such that $\epsilon
% \Ind_F = 1_{\Ind_F}$, since recursing in the algebra structure is trivial, and $uU_F \epsilon = 1_{uU_F}$, as the
% recursor should remain in the current context. In other words, we want an adjunction $\Ind_F \dashv uU_F$ with
% identity unit, where the counit corresponds to the recursor. Clearly this captures the non-dependent recursion
% rule, essentially by definition.
%
% For the dependent eliminator, we require some more effort. Let $q : e \to u$ denote the projection induced by
% context extension $e : \cU \to \cC$, and $c : e \to er\bar q$ the context contraction map, where $r : \cC \comma
% u \to \cU$ denotes the domain of the cartesian lifts for $u$ and $\bar q : \cU \to \cC \comma u$ the map induced
% by $q$. A dependent algebra over $F$ is simply an algebra $A : X \to F\Alg$ such that $uU_F A = euU_F\Ind_F
% \Gamma$ for some $\Gamma : X \to \cC$. The object of such algebras can thus be defined as a pullback
% \[\begin{codi}
%   \obj { R & F\Alg \\ |(C1)| \cC & |(C2)| \cC \\};
%   \mor R h:-> FAlg uU_F:-> C2;
%   \mor[swap] R p:-> C1 eU_F\Ind_F:-> C2;
% \end{codi}\]
% Since $h$ is an algebra, the recursor applied to $h$ gives $\epsilon h : \Ind_F uU_F h \to h$, and
% since $uU_F h = eU_F\Ind_F p$, we have $\epsilon h : \Ind_F eU_F\Ind_F p \to h$. We further have that
% $\Ind_F\dom\bar q U_F\Ind_Fp = \Ind_FeU_F\Ind_Fp$, so that $\epsilon h \circ \alpha \bar q U_F\Ind_Fp :
% r_F(\cC \comma \Ind_F)\bar q U_F\Ind_Fp \to h$.
%
% However, we also capture the dependent induction rule. Recall that the dependent elimination rule for inductive
% types has the form
% \[\infer{\Gamma . U_F\Ind_F \vdash A\;\cU \\ \Gamma . U_F\Ind_F . F A \vdash a : A}{\Gamma . U_F\Ind_F \vdash
% \ind_{(A,a)} : A}\]
% By \cref{lem:algebra as term}, the premise of the rule is an $\cF$-algebra lying over an extended
% context $\Gamma.U_F\Ind_F$, which we can capture as a pullback
% The induction rule should then be a morphism $\ind : R \to \dot\cU$ such that $\typ\ind = U_Fh$. The computation
% rule
% \[\infer{\Gamma . U_F\Ind_F \vdash A\;\cU \\ \Gamma . U_F\Ind_F . F A \vdash a : A}{\Gamma . U_F\Ind_F \vdash
% \ind_{(A,a)} : A}\]
%
% The induction rule should be a morphism $\ind : \Ind_F p \to h : R \to F\Alg$.
%
% Furthermore, letting $q : e \to u$
% denote the generic projection induced by context extension $e : \cU \to \cC$.
%
% The induction principle should be an $\cF$-algebra homomorphism $\Ind_F \to q$ morphism $\ind : R \to \dot\cU$
%
% Suppose we are given some $F$-algebra $A$ over a context
% $\Gamma.U_F\Ind_F$. In other words, maps $A : X \to F\Alg$ and $\Gamma : X \to \cC$ such that $uU_FA = \Gamma.
% U_F\Ind_F$. Then the recursor is a morphism $\epsilon A : \Ind_FuU_F A = \Ind_F(\Gamma.U_F \Ind_F) \to A$. Now
% note that the projection $q : e U_F \Ind_F \to u U_F \Ind_F = 1_\cC$ induces a cartesian lift $\bar q :
% \overline{e U_F \Ind_F} \to U_F \Ind_F$, which factors the identity $1_{U_F \Ind_F}$ through $c : U_F \Ind_F
% \to \overline {e U_F \Ind_F}$. Composing $\epsilon A \circ c $
%
% The premise to the depdendent induction rule
% \[\infer{\Gamma . U_F\Ind_F \vdash A\;\cU \\ \Gamma . U_f\Ind_F . F A \vdash a : A}{\Gamma . U_F\Ind_F \vdash
% \ind_{(A,a)} : A}\]
% can be constructed as a pullback
% \[\begin{codi}
%   \obj { R & F\Alg \\ |(C1)| \cC & |(C2)| \cC \\};
%   \mor R -> FAlg uU_F:-> C2;
%   \mor[swap] R -> C1 eU_F\Ind_F:-> C2;
% \end{codi}\]
% where $e : \cU \to \cC$ denotes the context extension map. 
%
% In particular, we have for $qU_F : eU_F \to uU_F : F\Alg \to \cC$, the weakening substitution associated to the
% carrier of an algebra, a cartesian lift $\bar q : \overline{eU_F} \to 1_{F\Alg}$. This map being cartesian
% induces an $\cF$-algebra homomorphism $1_{F\Alg} \to \overline{eU_F}$. In particular, for the inductive type
% $\Ind_F : \cC \to F-\Alg$, we have a contraction map $\bar q \Ind_F : \Ind_F \to \Ind_F[eU_F\Ind_F]$
% corresponding to weakening along the carrier of an algebra.
%
% Since this
%
% We want $\Ind_F \dashv uU_F$. For an algebra $B : X \to F\Alg$ with $uU_F B = \Gamma.U_F \Ind_F$ for some context
% $\Gamma$, we then have a 2-cell $\epsilon : \Ind_F uU_F B \to B$, i.e. an algebra homomorphism $U_F\epsilon :
% U_F\Ind_F(\Gamma.U_F\ind F) \to U_F B$. 
%
% We want to show that $F$-algebras are stable under stubstitution, meaning that $uU_F : \cF\Alg \to \cC$ is a
% fibration. To see this, we must construct a map $r' : \cC \comma uU_F \to \cF\Alg$ and a $uU_F$-cartesian
% 2-cell $\epsilon : r \to \cod$. The former corresponds to a map $\bar r' : \cC \comma uU_F \to \cU$ equipped
% with an $\cF$-algebra structure; this suggests that the underlying type $\bar r'$ should simply be $r(
% \cC \comma U_F)$, where $r : \cC \comma u \to \cU$ denotes the map choosing cartesian lifts and $(\cC \comma
% U_F) : \cC \comma uU_F \to \cC \comma u$ simply composes with $U_F$ in the second component. We also require
% a map $\phi : F\bar r' \to \bar r'$. Since $\ell(\cC \comma U_F) : r(\cC \comma U_F) \to U_F\cod$ is
% cartesian, it suffices to find a map $F\bar r' \to $
% \[\begin{codi}
%   \obj {};
% \end{codi}\]
% and this we find 
%
% Since $F$ preserves cartesian lifts (up to isomorphism), we have an isomorphism $\alpha : Fr \cong r(\cC \comma F)
% : \cC \comma u \to \cU$, where we use that $uF = u$ so that $\cC \comma F : \cC \comma uF \to \cC \comma u$
% has the correct domain. 
%
% Letting $q : e \to 1_u$ denote the projection from context extension, we thus have
% $\alpha q : Frq \to r(\cC\comma F)q$. 
%
% Furthermore, any algebra $a : X \to F\Alg$ can be turned into a map $\tilde a : X \to R$ by weakening with
% the map $q : e \to 1_\cC$:
% \[
%   x
% \]

% corresponds to a map $\tilde{a} : X \to \Box$.


% using $\tm_\bzero$ to denote the pullback $\tm \times_\ty \bzero$, we encode the premise of the induction rule as the pullback $\times \tm_\bzero$ $\mathsf{ind}_{\bzero} : (\tm \pb[]{\ty} \bzero)$

\section{Multimode and Modal type theories}
Multimode dependent type theory (MTT) was introduced in \cite{gratzer2021} to provide a general family of type theories
with different modalities. MTT is parameterized by a 2-category $\cM$, a so-called mode-theory, where the objects are
\emph{modes}, 1-cells are \emph{modalities}, and 2-cells are \emph{operations} between modalities.

At each mode $m \in \cM$, we have an instance of a normal dependent type theory at that mode, and the modalities allow for
transporting terms at one mode to another. In constructing a logic capturing MTT, we encode this by, for each mode
$m \in \cM$, giving a diagram
\[\begin{codi}[hexagonal=horizontal side 6em angle 45] 
  \obj{\tm_m &   \ty_m \\ & \ctx_m \\};
  \mor  (tm _m) ["\typ_m",swap]:≈> (ty _m) \rty:-> (ctx _m);
  \mor[swap] (tm _m) \rtm_m:-> (ctx _m);
  \mor[swap] (ty _m) \var_m:[bend right,≈>] (tm _m);
  \mor (typ _m) [shorten=0.3em, |-] (var _m);
\end{codi}\]
and all diagrams, equalities, and cones needed to turn this into a natural model. Then, for each modality $\mu : m \to
n \in \cM$, we add a morphism $\lock_\mu : \ctx_n \loose \ctx_m$, corresponding to the rule
\[\infer{\Gamma \ctx_n}{\Gamma. \lock_\mu \ctx_m}\]
To model the type former for modal types $\Gamma \ctx_m \vdash [\mu] A \ty_m$ for a type $\Gamma.\lock_\mu \ctx n
\vdash A \ty$ and modality $\mu : m \to n$, we add a loose 1-cell $[\mu] : \ctx_m \pb[\lock_\mu\mkern-6mu]{\rty_n}
\loose \rty_m$ subject to the condition that $\rty_m [\mu] = \pi_1$


\newpage

\ifSubfilesClassLoaded{\printbibliography}{}
\end{document}
